// Prisma schema for Life Insurance Status Tracking Portal

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// Admin team members
model User {
  id            String          @id @default(cuid())
  email         String          @unique
  passwordHash  String          @map("password_hash")
  name          String
  role          String          @default("admin")
  contactEmail  String?         @map("contact_email")   // Email for client contact (may differ from login email)
  contactPhone  String?         @map("contact_phone")   // Phone number for client contact
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  statusChanges StatusHistory[]
  assignedClients Client[]      @relation("AssignedAdmin")
  sentInvitations AdminInvitation[] @relation("InvitedBy")

  @@map("users")
}

// Admin invitations
model AdminInvitation {
  id          String   @id @default(cuid())
  email       String
  token       String   @unique
  name        String?
  contactEmail String?  @map("contact_email")
  contactPhone String?  @map("contact_phone")
  invitedById String   @map("invited_by_id")
  expiresAt   DateTime @map("expires_at")
  usedAt      DateTime? @map("used_at")
  createdAt   DateTime @default(now()) @map("created_at")

  invitedBy   User     @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email])
  @@map("admin_invitations")
}

// Insurance applicant clients
model Client {
  id              String          @id @default(cuid())
  email           String          @unique
  passwordHash    String          @map("password_hash")
  name            String
  phone           String?
  currentStage    Int             @default(1) @map("current_stage")
  assignedAdminId String?         @map("assigned_admin_id")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  statusHistory   StatusHistory[]
  emailOpens      EmailOpen[]
  assignedAdmin   User?           @relation("AssignedAdmin", fields: [assignedAdminId], references: [id])

  @@map("clients")
}

// Audit trail for status changes
model StatusHistory {
  id        String   @id @default(cuid())
  clientId  String   @map("client_id")
  stage     Int
  changedBy String   @map("changed_by")
  note      String?
  createdAt DateTime @default(now()) @map("created_at")

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [changedBy], references: [id])

  @@map("status_history")
}

// Email open tracking
model EmailOpen {
  id            String    @id @default(cuid())
  trackingId    String    @unique @map("tracking_id")
  clientId      String    @map("client_id")
  emailType     String    @map("email_type")  // "status_update", "welcome", "admin_invitation"
  subject       String?                        // Email subject for reference
  firstOpenedAt DateTime? @map("first_opened_at")
  lastOpenedAt  DateTime? @map("last_opened_at")
  openCount     Int       @default(0) @map("open_count")
  createdAt     DateTime  @default(now()) @map("created_at")

  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([trackingId])
  @@map("email_opens")
}
